
import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { CloudUpload, MapPin, Lock, Unlock, Zap, RotateCw, Settings, AlertTriangle, CheckCircle } from 'lucide-react';

// --- Configuration and Constants ---
const PIN_KEY = 'kijani_ai_pin_hash_v2';
const API_MODEL = "gemini-2.5-flash-preview-09-2025";
const MAX_RETRIES = 3;
const CURRENT_VERSION = "v2.0.1";

// --- Utility Functions ---

/**
 * Hashing function for securing the PIN locally.
 */
async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
}

/**
 * Converts a File object to a Base64 string for API transmission.
 */
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        if (file.size > 8 * 1024 * 1024) {
            reject(new Error("Image is too large (over 8MB). Please upload a compressed image."));
        }
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

/**
 * Renders the markdown output from the AI into readable HTML.
 */
function MarkdownRenderer({ markdownText }) {
    if (!markdownText) return null;

    let htmlContent = markdownText
        .replace(/^### (.*)$/gm, '<h3 class="text-xl font-semibold text-green-700 mt-6 border-b pb-1">$1</h3>')
        .replace(/^\* (.*)$/gm, '<li class="list-disc ml-6 text-gray-700">$1</li>')
        .replace(/\n\n/g, '<p class="mt-2 mb-2 text-gray-700">')
        .replace(/\n/g, ' ');

    htmlContent = htmlContent.replace(/<li/g, '<ul><li').replace(/<\/li>/g, '</li></ul>').replace(/<\/ul>\s*<ul>/g, '');
    htmlContent = `<div>${htmlContent}</div>`;

    return <div dangerouslySetInnerHTML={{ __html: htmlContent }} className="text-sm" />;
}


// --- API Call Function ---

/**
 * Fetches the diagnosis from the Gemini API with search grounding and retry logic.
 */
async function fetchDiagnosis(prompt, base64Image, locationData, attempt = 0) {
    // API_KEY is intentionally blank. The system relies on the secure canvas environment.
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=`;
    
    const parts = [];
    let fullPrompt = prompt;

    // 1. Add location and scouting context to the prompt
    if (locationData.lat && locationData.lon) {
        fullPrompt += `\n\nScouting Location: Latitude ${locationData.lat}, Longitude ${locationData.lon}.`;
    }
    if (locationData.mapping.length > 0) {
        fullPrompt += `\n\nArea Boundary: A polygon area containing ${locationData.mapping.length} scouted points has been defined. Adjust recommendations for zone-specific VRA treatment.`;
    }
    if (locationData.sensorData) {
        fullPrompt = `Sensor Data: ${locationData.sensorData}\n\nSymptom Description: ${fullPrompt}`;
    }


    const SYSTEM_PROMPT = `You are a specialized agricultural diagnosis AI named Kijani-AI, focusing on precision scouting. Analyze ALL provided inputs (Image, Symptom Description, Location/Scouting Data, and Sensor Data). Provide a single, most likely identification, and detail the five key aspects.

    Sensor Data is critical: If a nutrient deficiency is suggested by the visual symptoms, use the provided NPK/pH/Moisture readings to confirm or deny that specific deficiency and adjust your recommendations accordingly.

    Format your response clearly using the following mandatory headings exactly as written (in Markdown): 
    
    ### Disease/Organism
    [Your identified disease name or confirmed nutrient deficiency and the causative agent]
    
    ### Effects
    [List the primary damage and impact on the plant and yield.]
    
    ### Causes/Conditions
    [List the environmental conditions, host factors, or vectors that cause or favor this disease. MUST integrate sensor data confirmation if provided.]
    
    ### Recommended Control Measures
    [Provide specific, practical, and grounded recommendations for immediate management and control.]
    
    ### Broader Agricultural Practices
    [Provide general, preventative, and long-term farm management practices.]`;

    parts.push({ text: fullPrompt });
    
    if (base64Image) {
        parts.push({
            inlineData: {
                mimeType: 'image/jpeg', // Assuming JPEG or letting the browser determine via file-to-base64
                data: base64Image
            }
        });
    }

    const payload = {
        contents: [{ role: "user", parts: parts }],
        tools: [{ "google_search": {} }],
        systemInstruction: {
            parts: [{ text: SYSTEM_PROMPT }]
        },
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            let errorDetails = `HTTP Status ${response.status} (${response.statusText})`;
            if (response.status === 403 || response.status === 400) {
                 // CRITICAL ERROR: This is the security block we've been fighting.
                throw new Error(`API Error: HTTP Status 403 - Authorization Failed. The application is likely running from an unapproved domain. Please check the URL.`);
            }
            throw new Error(`API Error: ${errorDetails}`);
        }

        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!text) {
            throw new new Error("API response was valid but contained no generated text.");
        }

        return text;

    } catch (error) {
        if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
            throw new Error("Network Error: Connection interrupted or unstable. Check network settings.");
        }
        
        console.error(`Attempt ${attempt + 1} failed:`, error.message);
        if (attempt < MAX_RETRIES - 1) {
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
            await new Promise(resolve => setTimeout(resolve, delay));
            return fetchDiagnosis(prompt, base64Image, locationData, attempt + 1); 
        } else {
            throw error;
        }
    }
}


// --- React Components ---

/**
 * The main application component.
 */
const App = () => {
    // --- State Initialization ---
    const [isLocked, setIsLocked] = useState(true);
    const [pinInput, setPinInput] = useState('');
    const [pinStatus, setPinStatus] = useState('');
    const [pinAction, setPinAction] = useState('setup'); // 'setup' | 'login'
    
    const [latitude, setLatitude] = useState('');
    const [longitude, setLongitude] = useState('');
    const [isMapping, setIsMapping] = useState(false);
    const [scoutedArea, setScoutedArea] = useState([]);

    const [imageFile, setImageFile] = useState(null);
    const [symptomInput, setSymptomInput] = useState('');
    const [sensorInput, setSensorInput] = useState('');
    
    const [diagnosisResult, setDiagnosisResult] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [errorMessage, setErrorMessage] = useState('');
    const [currentVersion, setCurrentVersion] = useState(CURRENT_VERSION);


    // --- Environment & Security Check (useEffect) ---
    useEffect(() => {
        const storedPinHash = localStorage.getItem(PIN_KEY);
        if (storedPinHash) {
            setPinAction('login');
            setIsLocked(true);
        } else {
            setPinAction('setup');
            setIsLocked(true); // Always start locked for PIN setup
        }
    }, []);
    
    // Check if the app is running on a secure, public domain
    const isPubliclyDeployed = useMemo(() => {
        return window.location.protocol.includes('http') && !window.location.host.includes('localhost');
    }, []);

    // --- PIN Lock Handlers (Biosecurity) ---

    const handlePinAction = useCallback(async () => {
        if (pinInput.length !== 4) {
            setPinStatus("PIN must be 4 digits.");
            return;
        }
        setPinStatus("");

        const pinHash = await sha256(pinInput);
        const storedHash = localStorage.getItem(PIN_KEY);

        if (pinAction === 'setup') {
            localStorage.setItem(PIN_KEY, pinHash);
            setPinStatus("PIN set successfully!");
            setTimeout(() => setIsLocked(false), 500);
        } else if (pinAction === 'login') {
            if (pinHash === storedHash) {
                setPinStatus("Unlocked! All features enabled.");
                setTimeout(() => setIsLocked(false), 500);
            } else {
                setPinStatus("Incorrect PIN. Access Denied (Biosecurity Violation).");
            }
        }
        setPinInput('');
    }, [pinInput, pinAction]);

    const lockApp = useCallback(() => {
        setPinInput('');
        setPinStatus('');
        setPinAction('login');
        setIsLocked(true);
    }, []);


    // --- Geolocation Handlers ---

    const getGeolocation = useCallback(() => {
        setErrorMessage('');
        if (!navigator.geolocation) {
             setErrorMessage('Geolocation not supported by this browser.');
             return;
        }
        
        setIsLoading(true);
        
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);
            
            setLatitude(lat);
            setLongitude(lon);
            
            if (isMapping) {
                setScoutedArea(prev => [...prev, { lat, lon }]);
            }
            setIsLoading(false);
            setErrorMessage(`GPS point captured: Lat ${lat}, Lon ${lon}.`);

        }, (error) => {
            setIsLoading(false);
            let message = "Geolocation Error. ";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += "Permission Denied (Code 1). Grant access when prompted.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += "Position Unavailable. Try an open area (Code 2).";
                    break;
                case error.TIMEOUT:
                    message += "Request Timed Out (Code 3).";
                    break;
                default:
                    message += `Unknown Error Code ${error.code}.`;
            }
            setErrorMessage(message);
        }, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        });
    }, [isMapping]);


    // --- Mapping Handlers ---

    const toggleMapping = useCallback(() => {
        setIsMapping(prev => !prev);
        if (!isMapping) {
            setScoutedArea([]);
            setErrorMessage("Mapping started. Click 'Get GPS' to record area points.");
        } else {
            if (scoutedArea.length < 3) {
                setErrorMessage(`Mapping stopped. Area polygon requires at least 3 points. ${scoutedArea.length} captured.`, true);
                setScoutedArea([]);
            } else {
                setErrorMessage(`Mapping complete! ${scoutedArea.length} points recorded for the scouted area.`);
            }
        }
    }, [isMapping, scoutedArea.length]);

    // --- Core Diagnosis Handler ---

    const runDiagnosis = useCallback(async () => {
        setErrorMessage('');
        setDiagnosisResult('');
        
        const prompt = symptomInput.trim();
        const lat = latitude.trim();
        const lon = longitude.trim();

        // Validation: Must have at least a prompt OR an image
        if (!prompt && !imageFile) {
            setErrorMessage("Please provide a photo or describe the symptoms (or both).");
            return;
        }
        
        // CRITICAL Check: Block API call if running locally (where the 403 happens)
        if (!isPubliclyDeployed) {
            setErrorMessage("API Error: Hosting Environment Unapproved (HTTP 403). You MUST open the app using the public **.github.io** link to proceed.");
            return;
        }

        setIsLoading(true);

        try {
            let base64Image = null;
            if (imageFile) {
                base64Image = await fileToBase64(imageFile);
            }
            
            const locationData = {
                lat: lat,
                lon: lon,
                mapping: scoutedArea,
                sensorData: sensorInput.trim()
            };

            const resultText = await fetchDiagnosis(prompt, base64Image, locationData);
            
            if (resultText) {
                setDiagnosisResult(resultText);
                setErrorMessage("Diagnosis complete. Report generated.");
            } else {
                setErrorMessage("API returned an invalid or empty diagnosis result.", true);
            }

        } catch (error) {
            console.error("Diagnosis failed:", error);
            setErrorMessage(error.message);
        } finally {
            setIsLoading(false);
        }
    }, [symptomInput, imageFile, latitude, longitude, scoutedArea, sensorInput, isPubliclyDeployed]);
    
    // --- Version Check Handler ---
    const checkForUpdate = () => {
        setErrorMessage('');
        setIsLoading(true);
        setTimeout(() => {
            setIsLoading(false);
            setCurrentVersion(CURRENT_VERSION); // Simulating keeping the same version
            setErrorMessage(`Kijani-AI is running the latest version: ${CURRENT_VERSION}`);
        }, 1500);
    };


    // --- UI Structure ---

    if (isLocked) {
        return (
            <div className="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-90 transition-opacity duration-300 z-50">
                <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center mx-4">
                    <Lock className="w-12 h-12 text-green-600 mx-auto mb-4" />
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">
                        {pinAction === 'setup' ? 'Set Biosecurity PIN' : 'Access Control'}
                    </h2>
                    <p className="text-sm text-gray-600 mb-4">
                        {pinAction === 'setup' 
                            ? 'Enter a 4-digit PIN for owner access.'
                            : 'Enter your 4-digit PIN to unlock all scouting features.'
                        }
                    </p>
                    <input 
                        type="password" 
                        value={pinInput}
                        onChange={(e) => setPinInput(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handlePinAction()}
                        maxLength="4" 
                        className="w-full text-4xl text-center tracking-widest p-3 border-2 border-green-400 rounded-lg focus:ring-green-500 focus:border-green-500 transition shadow-inner" 
                        pattern="\d{4}" 
                        inputMode="numeric"
                    />
                    <button 
                        onClick={handlePinAction}
                        className="mt-6 w-full px-4 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150"
                    >
                        {pinAction === 'setup' ? 'Set & Unlock' : 'Unlock Access'}
                    </button>
                    {pinStatus && <p className={`text-sm mt-4 font-medium ${pinStatus.includes('Incorrect') ? 'text-red-500' : 'text-green-500'}`}>{pinStatus}</p>}
                </div>
            </div>
        );
    }

    // --- Main App UI ---
    return (
        <div className="min-h-screen flex flex-col items-center p-4 w-full max-w-lg mx-auto bg-gray-50">

            {/* Header and Controls */}
            <header className="w-full max-w-lg mb-4 bg-white shadow-lg rounded-xl p-4 flex justify-between items-center border-b-4 border-green-400">
                <h1 className="text-xl font-extrabold text-green-700 leading-tight flex items-center">
                    <Zap className="w-6 h-6 mr-2 text-green-500" />
                    Kijani-AI Scout <span className="text-xs ml-2 px-2 py-1 bg-gray-100 rounded-full text-gray-500">{currentVersion}</span>
                </h1>
                <div className='flex space-x-2'>
                    <button onClick={checkForUpdate} className="text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition duration-150 flex items-center">
                        <RotateCw className='w-4 h-4 mr-1' /> Update
                    </button>
                    <button onClick={lockApp} className="text-sm px-3 py-1 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition duration-150 flex items-center">
                        <Lock className='w-4 h-4 mr-1' /> Lock
                    </button>
                </div>
            </header>

            <main className="w-full max-w-lg">
                <div className="bg-white p-6 rounded-xl shadow-xl mb-6">
                    
                    {/* Location & Mapping Section */}
                    <div className="mb-6 border-b pb-4">
                        <h2 className="text-lg font-bold text-gray-700 mb-3 flex items-center"><MapPin className='w-5 h-5 mr-2 text-blue-500'/> Location & Mapping (Optional)</h2>
                        
                        {/* GPS Input Fields (Editable) */}
                        <div className="flex space-x-3 mb-3">
                            <input 
                                type="text" 
                                placeholder="Latitude (e.g., -1.2833)"
                                value={latitude}
                                onChange={(e) => setLatitude(e.target.value)}
                                className="w-1/2 p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"
                            />
                            <input 
                                type="text" 
                                placeholder="Longitude (e.g., 36.8167)"
                                value={longitude}
                                onChange={(e) => setLongitude(e.target.value)}
                                className="w-1/2 p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>

                        {/* Get GPS Button */}
                        <button 
                            onClick={getGeolocation} 
                            disabled={isLoading}
                            className={`w-full px-4 py-2 text-white font-semibold rounded-lg shadow-md transition duration-150 focus:outline-none focus:ring-4 text-sm mb-3 
                                ${isLoading ? 'bg-gray-400' : 'bg-blue-500 hover:bg-blue-600 focus:ring-blue-300'}`}
                        >
                            {isLoading ? 'Fetching GPS...' : 'Get Current GPS'}
                        </button>

                        {/* Mapping Controls */}
                        <div className="flex space-x-3 items-center">
                            <button 
                                onClick={toggleMapping} 
                                className={`flex-shrink-0 px-4 py-2 text-white font-semibold rounded-lg shadow-md transition duration-150 focus:outline-none focus:ring-4 text-sm 
                                    ${isMapping ? 'bg-red-500 hover:bg-red-600 focus:ring-red-300' : 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-300'}`}
                            >
                                {isMapping ? 'Stop Mapping' : 'Start Area Mapping'}
                            </button>
                            <div className="flex-grow p-2 bg-gray-100 rounded-lg text-xs text-gray-600 truncate">
                                Status: {isMapping ? 'MAPPING' : 'Idle'}. {scoutedArea.length} points captured.
                            </div>
                        </div>
                    </div>
                    
                    {/* Sensor Data Input */}
                    <label htmlFor="sensorInput" className="block text-sm font-bold text-gray-700 mb-2">Sensor Data (e.g., NPK, pH, Moisture):</label>
                    <textarea 
                        id="sensorInput" 
                        rows="2" 
                        value={sensorInput}
                        onChange={(e) => setSensorInput(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 shadow-sm mb-4 text-sm" 
                        placeholder="Paste data: e.g., pH: 5.2, N: 15 ppm, K: 250 ppm, Moisture: 60%"
                    ></textarea>

                    {/* Image Upload and Preview */}
                    <label className="block text-sm font-bold text-gray-700 mb-2">Upload Plant Image:</label>
                    <div className="mb-4 p-4 border-2 border-dashed border-gray-300 rounded-xl hover:border-green-500 transition duration-150">
                        <input 
                            type="file" 
                            id="imageInput" 
                            accept="image/*" 
                            onChange={(e) => setImageFile(e.target.files[0])}
                            className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
                        />
                        {imageFile && (
                            <img 
                                src={URL.createObjectURL(imageFile)} 
                                className="mt-4 w-full h-auto max-h-64 object-contain rounded-lg shadow-md" 
                                alt="Image Preview"
                            />
                        )}
                    </div>

                    {/* Symptom Description */}
                    <label htmlFor="symptomInput" className="block text-sm font-bold text-gray-700 mb-2">Describe Symptoms:</label>
                    <textarea 
                        id="symptomInput" 
                        rows="3" 
                        value={symptomInput}
                        onChange={(e) => setSymptomInput(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 shadow-sm text-sm" 
                        placeholder="e.g., Small, yellow-to-orange pustules on the underside of wheat leaves."
                    ></textarea>
                    
                    {/* Diagnosis Button & Status */}
                    <button 
                        onClick={runDiagnosis} 
                        disabled={isLoading}
                        className={`mt-6 w-full px-4 py-3 text-white font-bold rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 disabled:opacity-50 
                            ${isPubliclyDeployed ? 'bg-green-500 hover:bg-green-600 focus:ring-green-300' : 'bg-red-500 hover:bg-red-600 focus:ring-red-300'}`}
                    >
                        {isLoading ? (
                            <span className="flex items-center justify-center">
                                <RotateCw className="animate-spin w-5 h-5 mr-2" /> Analyzing Data...
                            </span>
                        ) : (
                            isPubliclyDeployed ? 'Run AI Diagnosis' : 'Run AI Diagnosis (Requires Deployment)'
                        )}
                    </button>
                    
                    {/* Status Message Display */}
                    {errorMessage && (
                        <p className={`text-sm text-center mt-3 p-2 rounded-lg font-medium flex items-center justify-center 
                            ${errorMessage.includes('API Error') || errorMessage.includes('Denied') || errorMessage.includes('Geolocation Error')
                                ? 'bg-red-100 text-red-600' : 'bg-green-100 text-gray-700'}`}>
                            {errorMessage.includes('API Error') || errorMessage.includes('Geolocation Error') ? <AlertTriangle className='w-4 h-4 mr-2' /> : <CheckCircle className='w-4 h-4 mr-2' />}
                            {errorMessage}
                        </p>
                    )}
                    
                </div>
                
                {/* Deployment Warning */}
                {!isPubliclyDeployed && (
                    <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6">
                        <p className="font-bold flex items-center"><AlertTriangle className='w-4 h-4 mr-2' /> CRITICAL DEPLOYMENT WARNING</p>
                        <p className="text-sm mt-1">
                            The app is running from an unapproved domain. The AI diagnosis feature **will fail** with an HTTP 403 error. You MUST open the app using your public **.github.io** link.
                        </p>
                    </div>
                )}


                {/* Diagnosis Report Section */}
                {diagnosisResult && (
                    <div className="w-full max-w-lg mt-8 mb-8">
                        <div className="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-green-500">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                Kijani-AI Diagnosis Report
                            </h2>
                            <MarkdownRenderer markdownText={diagnosisResult} />
                        </div>
                    </div>
                )}
            </main>
        </div>
    );
};

export default App;


